(function(){
  const VAR_PER_STAY = 190; // MAD
  const DEFAULT_AVG_NIGHTS = 3.0;
  const OPS = { noise:{occ:-3}, stairs:{occ:-2}, parking:{occ:-2}, hoa:{occ:-1.5}, gated:{occ:-1}, hardToFind:{occ:-1}, noSelfCheck:{occ:-1}, delicate:{var:+50} };
  function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
  function pct(n){ return Number(n)/100; }
  function round(n){ return Math.round(n); }
  function money(n){ return n.toLocaleString(undefined,{maximumFractionDigits:0}); }
  function expectedStays(occPercent, avgNights){ const nightsPerMonth=30*(occPercent/100); return nightsPerMonth/avgNights; }
  function applyOps(bADR,bOcc,flags){ let occ=bOcc, varBump=0; for(const k in flags){ if(flags[k]){ const r=OPS[k]||{}; if(r.occ) occ+=r.occ; if(r.var) varBump+=r.var; } } occ=clamp(occ,15,bOcc); return {adr:bADR, occ, varPerStay:VAR_PER_STAY+varBump}; }
  function fillNeighborhoodUnit(nSelQ,uSelQ){ const BL=window.DRP_BASELINES||{}; const nSel=document.querySelector(nSelQ); const uSel=document.querySelector(uSelQ); nSel.innerHTML=""; Object.keys(BL).forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;nSel.appendChild(o);}); function refresh(){ const list=BL[nSel.value]?Object.keys(BL[nSel.value]):[]; uSel.innerHTML=""; list.forEach(u=>{const o=document.createElement('option');o.value=u;o.textContent=u;uSel.appendChild(o);}); } nSel.addEventListener('change',refresh); refresh(); }
  function cohostCalc(cfg){ const BL=window.DRP_BASELINES; const n=document.querySelector(cfg.neighborhoodSel).value; const u=document.querySelector(cfg.unitSel).value; const base=BL&&BL[n]&&BL[n][u]; if(!base)return; const flags={noise:cfg.opsSel('noise').checked, stairs:cfg.opsSel('stairs').checked, parking:cfg.opsSel('parking').checked, hoa:cfg.opsSel('hoa').checked, gated:cfg.opsSel('gated').checked, hardToFind:cfg.opsSel('hard').checked, noSelfCheck:cfg.opsSel('noself').checked, delicate:cfg.opsSel('delicate').checked}; const tuned=applyOps(base.adr, base.occ, flags); const stays=expectedStays(tuned.occ, cfg.avgNights()); const gross=tuned.adr*tuned.occ/100*30; const varMonthly=tuned.varPerStay*stays; const fee=gross*pct(cfg.feePct()); const fixed=cfg.internet()+cfg.insurance()+cfg.hoa(); const ownerNet=gross-varMonthly-fee-fixed; const baseStays=expectedStays(base.occ,cfg.avgNights()); const baseGross=base.adr*base.occ/100*30; const baseVar=VAR_PER_STAY*baseStays; const baseOwner=baseGross-baseVar-(baseGross*pct(cfg.feePct()))-fixed; cfg.outEls.gross.textContent=money(Math.round(gross)); cfg.outEls.stays.textContent=round(stays).toString(); cfg.outEls.varMonthly.textContent=money(Math.round(varMonthly)); cfg.outEls.fee.textContent=money(Math.round(fee))+" ("+cfg.feePct()+"%)"; cfg.outEls.fixed.textContent=money(Math.round(fixed)); cfg.outEls.ownerNet.textContent=money(Math.round(ownerNet)); cfg.outEls.baseOwner.textContent=money(Math.round(baseOwner)); }
  function leaseCalc(cfg){ const BL=window.DRP_BASELINES; const n=document.querySelector(cfg.neighborhoodSel).value; const u=document.querySelector(cfg.unitSel).value; const base=BL&&BL[n]&&BL[n][u]; if(!base)return; const flags={noise:cfg.opsSel('noise').checked, stairs:cfg.opsSel('stairs').checked, parking:cfg.opsSel('parking').checked, hoa:cfg.opsSel('hoa').checked, gated:cfg.opsSel('gated').checked, hardToFind:cfg.opsSel('hard').checked, noSelfCheck:cfg.opsSel('noself').checked, delicate:cfg.opsSel('delicate').checked}; const tuned=applyOps(base.adr, base.occ, flags); const stays=expectedStays(tuned.occ, cfg.avgNights()); const gross=tuned.adr*tuned.occ/100*30; const varMonthly=190*stays; const fixed=cfg.fixedMonthly()+cfg.amortMAD(); const checkedCount=Object.values(flags).filter(Boolean).length; let margin=(cfg.marginPct()/100)*gross; if(checkedCount>=3) margin += (2/100)*gross; const cap=gross-varMonthly-fixed-margin; const offer=cap*0.95; cfg.outEls.gross.textContent=money(Math.round(gross)); cfg.outEls.stays.textContent=(Math.round(stays*10)/10).toString(); cfg.outEls.varPerStay.textContent=money(190); cfg.outEls.fixed.textContent=money(Math.round(fixed)); cfg.outEls.margin.textContent=money(Math.round(margin)); cfg.outEls.cap.textContent=money(Math.round(cap)); cfg.outEls.offer.textContent=money(Math.round(offer)); cfg.outEls.avgNights.textContent=(Math.round(cfg.avgNights()*10)/10).toString(); }
  window.DRP={ fillNeighborhoodUnit, cohostCalc, leaseCalc, DEFAULT_AVG_NIGHTS };
})();